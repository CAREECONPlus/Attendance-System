<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>勤怠管理システム</title>
    <link rel="stylesheet" href="css/style.css">
    
    <!-- Favicon追加 -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📋</text></svg>">
    
    <!-- Firebase v8 SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- Firebase設定 -->
    <script src="js/firebase.js"></script>
    
    <!-- システムのJavaScript -->
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/main.js"></script>
    <script src="js/employee.js"></script>
    <script src="js/admin.js"></script>
</head>
<body>
    <!-- ログインページ -->
    <div id="login-page" class="page">
        <div class="container login-container">
            <div class="login-card">
                <h1>勤怠管理システム</h1>
                <p class="login-subtitle">ログイン</p>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label for="email">メールアドレス</label>
                        <input type="email" id="email" name="email" autocomplete="email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">パスワード</label>
                        <input type="password" id="password" name="password" autocomplete="current-password" required>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-full">ログイン</button>
                    </div>
                    
                    <div id="error-message" class="error-text hidden"></div>
                </form>
                
                <div class="login-footer">
                    <p>アカウントをお持ちでない方は</p>
                    <a href="#" id="go-to-register" class="link">新規登録はこちら</a>
                </div>
            </div>
        </div>
    </div>

    <!-- 新規登録ページ -->
    <div id="register-page" class="page hidden">
        <div class="login-container">
            <div class="login-card">
                <h1>勤怠管理システム</h1>
                <h2>新規ユーザー登録</h2>
                <form id="registerForm">
                    <div class="form-group">
                        <label for="reg-fullname">氏名</label>
                        <input type="text" id="reg-fullname" name="fullname" required>
                    </div>
                    <div class="form-group">
                        <label for="reg-email">メールアドレス</label>
                        <input type="email" id="reg-email" name="email" autocomplete="email" required>
                    </div>
                    <div class="form-group">
                        <label for="reg-password">パスワード</label>
                        <input type="password" id="reg-password" name="password" autocomplete="new-password" required>
                        <div class="form-hint">6文字以上で入力してください</div>
                    </div>
                    <div class="form-group">
                        <label for="reg-role">役割</label>
                        <select id="reg-role" name="role">
                            <option value="employee">従業員</option>
                            <option value="admin">管理者</option>
                        </select>
                    </div>
                    <div id="register-message" class="error-text"></div>
                    <button type="submit" class="btn btn-primary btn-full">登録する</button>
                </form>
                <p style="text-align: center; margin-top: 20px;">
                    すでにアカウントをお持ちの方は<br>
                    <a href="#" id="back-to-login">ログインはこちら</a>
                </p>
            </div>
        </div>
    </div>

    <!-- 従業員画面 -->
    <div id="employee-page" class="page hidden">
        <div class="container">
            <header class="app-header">
                <h1>勤怠管理システム</h1>
                <div class="user-info">
                    <span id="user-name"></span>
                    <button class="btn btn-secondary btn-small" id="logout-btn">ログアウト</button>
                </div>
            </header>

            <main class="employee-main">
                <!-- 現在時刻表示 -->
                <div class="date-display">
                    <div class="date" id="current-date">日付読み込み中...</div>
                    <div class="time" id="current-time">時刻読み込み中...</div>
                </div>

                <!-- 勤務状況 -->
                <div id="clock-status" class="clock-status">
                    <div class="status-waiting">出勤ボタンを押してください</div>
                </div>

                <!-- 出退勤・休憩ボタン -->
                <div class="clock-buttons">
                    <div class="button-row">
                        <button class="btn btn-primary clock-btn" id="clock-in-btn">出勤</button>
                        <button class="btn btn-secondary clock-btn" id="clock-out-btn" disabled>退勤</button>
                    </div>
                    <div class="button-row">
                        <button class="btn btn-warning clock-btn" id="break-start-btn" disabled>休憩開始</button>
                        <button class="btn btn-warning clock-btn" id="break-end-btn" disabled>休憩終了</button>
                    </div>
                </div>

                <!-- 現場選択 -->
                <div class="site-selection">
                    <div class="form-group">
                        <label for="site-name">現場名：</label>
                        <select id="site-name" required>
                            <option value="">現場を選択してください</option>
                            <option value="新宿オフィスビル改修工事">新宿オフィスビル改修工事</option>
                            <option value="渋谷マンション建設現場">渋谷マンション建設現場</option>
                            <option value="横浜倉庫補修工事">横浜倉庫補修工事</option>
                            <option value="other">その他（直接入力）</option>
                        </select>
                        <input type="text" id="other-site" placeholder="その他の現場名を入力" style="display: none; margin-top: 10px;">
                    </div>
                </div>

                <!-- 作業メモ -->
                <div class="form-group">
                    <label for="work-notes">作業メモ：</label>
                    <textarea id="work-notes" placeholder="作業内容を記入（任意）" rows="3"></textarea>
                </div>

                <!-- 最近の記録 -->
                <section class="recent-records">
                    <h3>最近の記録</h3>
                    <div id="recent-list">
                        <!-- 動的に生成 -->
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- 管理者画面 -->
    <div id="admin-page" class="page hidden">
        <div class="container">
            <header class="app-header">
                <h1>勤怠管理システム</h1>
                <div class="user-info">
                    <span id="admin-user-name"></span>
                    <button id="admin-logout-btn" class="btn btn-secondary btn-small">ログアウト</button>
                </div>
            </header>

            <main class="admin-main">
                <div class="admin-tabs">
                    <button class="tab-btn active" data-tab="daily">日別表示</button>
                    <button class="tab-btn" data-tab="monthly">月別表示</button>
                    <button class="tab-btn" data-tab="employee">従業員別</button>
                    <button class="tab-btn" data-tab="site">現場別</button>
                </div>

                <div class="filter-row">
                    <div class="date-filter">
                        <label class="filter-label">日付:</label>
                        <input type="date" id="filter-date">
                    </div>
                    <div class="month-filter hidden">
                        <label class="filter-label">月:</label>
                        <input type="month" id="filter-month">
                    </div>
                    <div class="employee-filter hidden">
                        <label class="filter-label">従業員:</label>
                        <select id="filter-employee">
                            <option value="">全員</option>
                        </select>
                    </div>
                    <div class="site-filter hidden">
                        <label class="filter-label">現場:</label>
                        <select id="filter-site">
                            <option value="">全ての現場</option>
                        </select>
                    </div>
                    <div class="filter-actions">
                        <button id="export-csv" class="btn btn-primary">CSV出力</button>
                    </div>
                </div>

                <div class="attendance-table-container">
                    <table class="attendance-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="userName">従業員名</th>
                                <th class="sortable" data-sort="date">日付</th>
                                <th class="sortable" data-sort="siteName">現場名</th>
                                <th>勤務時間</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-data">
                            <!-- 勤怠データが表示されます -->
                        </tbody>
                    </table>
                </div>
            </main>
        </div>

        <!-- 勤怠データ編集モーダル -->
        <div id="edit-modal" class="modal hidden">
            <div class="modal-content">
                <button class="close-btn">&times;</button>
                <h2>勤怠データ編集</h2>
                <form id="edit-form">
                    <input type="hidden" id="edit-id">
                    
                    <div class="form-group">
                        <label for="edit-date">日付:</label>
                        <input type="date" id="edit-date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-site">現場名:</label>
                        <input type="text" id="edit-site" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="edit-clock-in">出勤時間:</label>
                            <input type="datetime-local" id="edit-clock-in" required>
                        </div>
                        <div class="form-col">
                            <label for="edit-clock-out">退勤時間:</label>
                            <input type="datetime-local" id="edit-clock-out">
                        </div>
                    </div>
                    
                    <div class="break-times">
                        <div class="break-title">
                            <span>休憩時間</span>
                            <button type="button" id="add-break-btn" class="btn btn-small btn-warning">追加</button>
                        </div>
                        <div id="break-list" class="break-list">
                            <!-- 休憩時間リスト -->
                        </div>
                        <div id="total-break-time" class="form-hint" style="text-align: right; margin-top: 10px;">
                            合計休憩時間: 0時間0分
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-notes">メモ:</label>
                        <textarea id="edit-notes" rows="3"></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">保存</button>
                        <button type="button" id="delete-record" class="btn btn-danger">削除</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 休憩時間追加モーダル -->
        <div id="break-modal" class="modal hidden">
            <div class="modal-content">
                <button class="close-btn" id="close-break-modal">&times;</button>
                <h2>休憩時間の追加</h2>
                <form id="break-form">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="break-start">開始時間:</label>
                            <input type="datetime-local" id="break-start" required>
                        </div>
                        <div class="form-col">
                            <label for="break-end">終了時間:</label>
                            <input type="datetime-local" id="break-end" required>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">追加</button>
                        <button type="button" id="cancel-break" class="btn btn-secondary">キャンセル</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ページ固有のJavaScript -->
    <script src="js/login.js"></script>
    
    <script>
        // ページの初期設定
        document.addEventListener('DOMContentLoaded', function() {
            // ログインページを表示
            showPage('login');
        });
    </script>

    <!-- 完全な従業員ページ修正スクリプト -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔧 完全な従業員ページ修正スクリプトを開始...');
            
            // 全ての Firestore クエリを単純化
            overrideFirestoreQueries();
            
            // 従業員ページ初期化の完全な上書き
            overrideEmployeeInitialization();
            
            // エラーハンドリングの強化
            setupGlobalErrorHandling();
        });

        // Firestoreクエリの完全な上書き
        function overrideFirestoreQueries() {
            console.log('📝 Firestoreクエリを上書き中...');
            
            // 最近の記録読み込みを完全に安全にする
            window.loadRecentRecords = async function() {
                console.log('🔍 安全な最近の記録読み込みを実行...');
                
                try {
                    const user = firebase.auth().currentUser;
                    if (!user) {
                        console.log('❌ ユーザーが認証されていません');
                        showNoRecordsMessage();
                        return;
                    }
                    
                    // 最もシンプルなクエリのみ実行
                    const simpleQuery = firebase.firestore()
                        .collection('attendance')
                        .where('userId', '==', user.uid)
                        .limit(3);
                    
                    console.log('🔄 シンプルクエリを実行中...');
                    const snapshot = await simpleQuery.get();
                    
                    if (snapshot.empty) {
                        console.log('📋 記録が見つかりません');
                        showNoRecordsMessage();
                        return;
                    }
                    
                    console.log('✅ 記録取得成功:', snapshot.size, '件');
                    displayRecords(snapshot);
                    
                } catch (error) {
                    console.error('❌ クエリエラー:', error);
                    handleQueryError(error);
                }
            };
            
            // 出勤処理の簡略化
            window.handleClockIn = async function() {
                console.log('🏢 出勤処理を実行...');
                
                try {
                    const user = firebase.auth().currentUser;
                    if (!user) {
                        alert('ログインが必要です');
                        return;
                    }
                    
                    const siteName = document.getElementById('site-name').value;
                    if (!siteName) {
                        alert('現場を選択してください');
                        return;
                    }
                    
                    const now = new Date();
                    const dateString = now.toISOString().split('T')[0];
                    
                    // シンプルなドキュメント作成
                    const docData = {
                        userId: user.uid,
                        date: dateString,
                        siteName: siteName,
                        startTime: now.toLocaleTimeString('ja-JP'),
                        status: 'working',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    console.log('💾 出勤データを保存中...', docData);
                    
                    await firebase.firestore()
                        .collection('attendance')
                        .add(docData);
                    
                    console.log('✅ 出勤記録完了');
                    alert('出勤しました');
                    
                    // UI更新
                    updateClockStatus('working');
                    loadRecentRecords();
                    
                } catch (error) {
                    console.error('❌ 出勤エラー:', error);
                    alert('出勤記録でエラーが発生しました: ' + error.message);
                }
            };
        }

        // 従業員ページ初期化の完全上書き
        function overrideEmployeeInitialization() {
            console.log('🎯 従業員ページ初期化を上書き中...');
            
            // 既存の初期化関数を置き換え
            window.initEmployeePage = function() {
                console.log('🚀 従業員ページ初期化開始（修正版）');
                
                try {
                    // 基本的な時刻表示
                    updateCurrentTime();
                    setInterval(updateCurrentTime, 1000);
                    
                    // ボタンイベントのセットアップ
                    setupButtonEvents();
                    
                    // 現場選択の設定
                    setupSiteSelection();
                    
                    // 最近の記録を安全に読み込み
                    setTimeout(loadRecentRecords, 2000);
                    
                    console.log('✅ 従業員ページ初期化完了（修正版）');
                    
                } catch (error) {
                    console.error('❌ 初期化エラー:', error);
                    // エラーが発生しても基本機能は動作させる
                    setupBasicFunctions();
                }
            };
        }

        // グローバルエラーハンドリング
        function setupGlobalErrorHandling() {
            console.log('🛡️ グローバルエラーハンドリングを設定中...');
            
            // Firestoreエラーをキャッチ
            window.addEventListener('unhandledrejection', function(event) {
                if (event.reason && event.reason.code) {
                    console.log('🔍 Firestoreエラーをキャッチ:', event.reason.code);
                    
                    if (event.reason.code === 'failed-precondition' || 
                        event.reason.code === 'permission-denied') {
                        console.log('🛠️ インデックスエラーを無視して続行');
                        event.preventDefault();
                        
                        // エラーメッセージを表示
                        showIndexErrorMessage();
                    }
                }
            });
        }

        // 基本機能のセットアップ
        function setupBasicFunctions() {
            console.log('⚙️ 基本機能をセットアップ中...');
            
            // 現在時刻表示
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // ボタンイベント
            setupButtonEvents();
            
            // 現場選択
            setupSiteSelection();
            
            console.log('✅ 基本機能セットアップ完了');
        }

        // ボタンイベントの設定
        function setupButtonEvents() {
            console.log('🔘 ボタンイベントを設定中...');
            
            const clockInBtn = document.getElementById('clock-in-btn');
            const clockOutBtn = document.getElementById('clock-out-btn');
            const breakStartBtn = document.getElementById('break-start-btn');
            const breakEndBtn = document.getElementById('break-end-btn');
            
            if (clockInBtn) clockInBtn.onclick = handleClockIn;
            if (clockOutBtn) clockOutBtn.onclick = handleClockOut;
            if (breakStartBtn) breakStartBtn.onclick = handleBreakStart;
            if (breakEndBtn) breakEndBtn.onclick = handleBreakEnd;
            
            console.log('✅ ボタンイベント設定完了');
        }

        // 現場選択の設定
        function setupSiteSelection() {
            const siteSelect = document.getElementById('site-name');
            const otherSiteInput = document.getElementById('other-site');
            
            if (siteSelect) {
                siteSelect.onchange = function() {
                    if (this.value === 'other') {
                        otherSiteInput.style.display = 'block';
                        otherSiteInput.required = true;
                    } else {
                        otherSiteInput.style.display = 'none';
                        otherSiteInput.required = false;
                    }
                };
            }
        }

        // 現在時刻の更新
        function updateCurrentTime() {
            const now = new Date();
            const dateElement = document.getElementById('current-date');
            const timeElement = document.getElementById('current-time');
            
            if (dateElement) {
                dateElement.textContent = now.toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
            }
            
            if (timeElement) {
                timeElement.textContent = now.toLocaleTimeString('ja-JP');
            }
        }

        // 記録なしメッセージの表示
        function showNoRecordsMessage() {
            const recentList = document.getElementById('recent-list');
            if (recentList) {
                recentList.innerHTML = `
                    <div class="no-records-safe">
                        <h4>🎯 勤怠システムへようこそ</h4>
                        <p>まだ勤怠記録がありません</p>
                        <p>出勤ボタンを押して勤務を開始しましょう</p>
                        <div class="tips">
                            <strong>使い方:</strong>
                            <ol>
                                <li>現場を選択</li>
                                <li>出勤ボタンをクリック</li>
                                <li>休憩時は休憩ボタンを使用</li>
                                <li>退勤時は退勤ボタンをクリック</li>
                            </ol>
                        </div>
                    </div>
                `;
            }
        }

        // 記録の表示
        function displayRecords(snapshot) {
            const recentList = document.getElementById('recent-list');
            if (!recentList) return;
            
            let html = '<h4>📋 最近の記録</h4>';
            
            snapshot.forEach(doc => {
                const data = doc.data();
                html += `
                    <div class="record-item-safe">
                        <div class="record-header">
                            <span class="record-date">${data.date || '日付不明'}</span>
                            <span class="record-status">${data.status || '状態不明'}</span>
                        </div>
                        <div class="record-details">
                            <div class="record-site">📍 ${data.siteName || '現場不明'}</div>
                            <div class="record-time">
                                ⏰ 開始: ${data.startTime || '不明'}
                                ${data.endTime ? ` 終了: ${data.endTime}` : ' (勤務中)'}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            recentList.innerHTML = html;
        }

        // クエリエラーの処理
        function handleQueryError(error) {
            console.log('🔧 クエリエラーを処理中:', error.code);
            
            const recentList = document.getElementById('recent-list');
            if (recentList) {
                recentList.innerHTML = `
                    <div class="error-safe">
                        <h4>⚠️ データ読み込みの注意</h4>
                        <p>記録の読み込みで問題が発生しました</p>
                        <p><strong>出勤・退勤機能は正常に動作します</strong></p>
                        <button onclick="loadRecentRecords()" class="retry-btn">🔄 再試行</button>
                        <div class="error-info">
                            <details>
                                <summary>エラー詳細</summary>
                                <code>${error.message}</code>
                            </details>
                        </div>
                    </div>
                `;
            }
        }

        // インデックスエラーメッセージ
        function showIndexErrorMessage() {
            const message = document.createElement('div');
            message.className = 'index-error-notice';
            message.innerHTML = `
                <div class="notice-content">
                    <h4>🔍 システム情報</h4>
                    <p>Firestoreの設定を最適化中です</p>
                    <p><strong>勤怠機能は正常に動作します</strong></p>
                </div>
            `;
            message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                border-radius: 8px;
                padding: 15px;
                max-width: 300px;
                z-index: 9999;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            `;
            
            document.body.appendChild(message);
            
            setTimeout(() => {
                if (message.parentNode) {
                    message.parentNode.removeChild(message);
                }
            }, 8000);
        }

        // 勤務状況の更新
        function updateClockStatus(status) {
            const statusElement = document.getElementById('clock-status');
            if (statusElement) {
                let message = '';
                switch(status) {
                    case 'working':
                        message = '<div class="status-working">✅ 勤務中です</div>';
                        break;
                    case 'break':
                        message = '<div class="status-break">⏸️ 休憩中です</div>';
                        break;
                    default:
                        message = '<div class="status-waiting">⏰ 出勤ボタンを押してください</div>';
                }
                statusElement.innerHTML = message;
            }
        }

        // CSS追加
        const additionalCSS = `
            .no-records-safe, .error-safe {
                text-align: center;
                padding: 20px;
                border: 2px dashed #3498db;
                border-radius: 12px;
                background: #f8f9fa;
                margin: 15px 0;
            }
            
            .no-records-safe h4, .error-safe h4 {
                color: #2c3e50;
                margin-bottom: 10px;
            }
            
            .tips {
                text-align: left;
                background: #e8f4fd;
                padding: 15px;
                border-radius: 8px;
                margin-top: 15px;
            }
            
            .tips ol {
                margin: 10px 0;
                padding-left: 20px;
            }
            
            .record-item-safe {
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 12px;
                margin-bottom: 10px;
                background: #fff;
            }
            
            .record-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            }
            
            .record-date {
                font-weight: bold;
                color: #2c3e50;
            }
            
            .record-status {
                background: #3498db;
                color: white;
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 0.8em;
            }
            
            .record-details {
                font-size: 0.9em;
                color: #7f8c8d;
            }
            
            .retry-btn {
                background: #3498db;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                margin-top: 10px;
            }
            
            .retry-btn:hover {
                background: #2980b9;
            }
            
            .error-info {
                margin-top: 10px;
                text-align: left;
            }
            
            .error-info code {
                background: #f1f2f6;
                padding: 5px;
                border-radius: 3px;
                font-size: 0.8em;
            }
            
            .status-working {
                color: #27ae60;
                font-weight: bold;
                padding: 10px;
                background: #d5f4e6;
                border-radius: 8px;
            }
            
            .status-break {
                color: #f39c12;
                font-weight: bold;
                padding: 10px;
                background: #fef9e7;
                border-radius: 8px;
            }
            
            .status-waiting {
                color: #7f8c8d;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 8px;
            }
        `;

        // CSS追加
        const styleSheet = document.createElement('style');
        styleSheet.textContent = additionalCSS;
        document.head.appendChild(styleSheet);

        console.log('🎉 完全な従業員ページ修正スクリプトの読み込み完了');
    </script>

</body>
</html>
