<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>勤怠管理システム</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- ログイン/ユーザーセクション -->
    <div id="login-section" style="display: none;">
        <div class="container">
            <div class="login-card">
                <h1>勤怠管理システム</h1>
                <p>サービスを利用するには<a href="login.html">ログイン</a>または<a href="register.html">新規登録</a>してください。</p>
            </div>
        </div>
    </div>
    
    <div id="user-section" style="display: none;">
        <div class="user-header">
            <p>ようこそ、<span id="user-name" class="user-name"></span>さん</p>
            <button id="logout-button" class="btn logout-button">ログアウト</button>
        </div>
    </div>

    <!-- 従業員画面 -->
    <div id="employee-page" class="page hidden">
        <div class="container">
            <header class="app-header">
                <h1>勤怠管理システム</h1>
                <div class="user-info">
                    <span id="user-name"></span>
                    <button class="btn btn-secondary btn-small" id="logout-btn">ログアウト</button>
                </div>
            </header>

            <main class="employee-main">
                <!-- 現在時刻表示 -->
                <div class="date-display">
                    <div class="date" id="current-date"></div>
                    <div class="time" id="current-time"></div>
                </div>

                <!-- 勤務状況 -->
                <div id="clock-status" class="clock-status">
                    <div class="status-waiting">出勤ボタンを押してください</div>
                </div>

                <!-- 出退勤・休憩ボタン -->
                <div class="clock-buttons">
                    <div class="button-row">
                        <button class="btn btn-primary clock-btn" id="clock-in-btn">出勤</button>
                        <button class="btn btn-secondary clock-btn" id="clock-out-btn" disabled>退勤</button>
                    </div>
                    <div class="button-row">
                        <button class="btn btn-warning clock-btn" id="break-start-btn" disabled>休憩開始</button>
                        <button class="btn btn-warning clock-btn" id="break-end-btn" disabled>休憩終了</button>
                    </div>
                </div>

                <!-- 現場選択 -->
                <div class="site-selection">
                    <div class="form-group">
                        <label for="site-name">現場名：</label>
                        <select id="site-name" required>
                            <option value="">現場を選択してください</option>
                        </select>
                        <input type="text" id="other-site" placeholder="その他の現場名を入力" style="display: none; margin-top: 10px;">
                    </div>
                </div>

                <!-- 作業メモ -->
                <div class="form-group">
                    <label for="work-notes">作業メモ：</label>
                    <textarea id="work-notes" placeholder="作業内容を記入（任意）" rows="3"></textarea>
                </div>

                <!-- 最近の記録 -->
                <section class="recent-records">
                    <h3>最近の記録</h3>
                    <div id="recent-list">
                        <!-- 動的に生成 -->
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- 管理者画面 -->
    <div id="admin-page" class="hidden">
        <div class="container">
            <header class="app-header">
                <h1>勤怠管理システム</h1>
                <div class="user-info">
                    <span id="admin-user-name" class="user-name"></span>
                    <button id="admin-logout-btn" class="btn btn-small logout-button">ログアウト</button>
                </div>
            </header>

            <main class="admin-main">
                <div class="admin-tabs">
                    <button class="tab-btn active" data-tab="daily">日別表示</button>
                    <button class="tab-btn" data-tab="monthly">月別表示</button>
                    <button class="tab-btn" data-tab="employee">従業員別</button>
                    <button class="tab-btn" data-tab="site">現場別</button>
                </div>

                <div class="filter-row">
                    <div class="date-filter">
                        <label class="filter-label">日付:</label>
                        <input type="date" id="filter-date">
                    </div>
                    <div class="month-filter hidden">
                        <label class="filter-label">月:</label>
                        <input type="month" id="filter-month">
                    </div>
                    <div class="employee-filter hidden">
                        <label class="filter-label">従業員:</label>
                        <select id="filter-employee">
                            <option value="">全員</option>
                            <!-- 従業員リストは動的に生成 -->
                        </select>
                    </div>
                    <div class="site-filter hidden">
                        <label class="filter-label">現場:</label>
                        <select id="filter-site">
                            <option value="">全ての現場</option>
                            <!-- 現場リストは動的に生成 -->
                        </select>
                    </div>
                    <div class="filter-actions">
                        <button id="export-csv" class="btn btn-primary">CSV出力</button>
                    </div>
                </div>

                <div class="attendance-table-container">
                    <table class="attendance-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="userName">従業員名</th>
                                <th class="sortable" data-sort="date">日付</th>
                                <th class="sortable" data-sort="siteName">現場名</th>
                                <th>勤務時間</th>
                                <th>操作</th>
                           </tr>
                       </thead>
                        <tbody id="attendance-data">
                            <!-- 勤怠データが表示されます -->
                        </tbody>
                    </table>
                </div>
            </main>
        </div>

        <!-- 勤怠データ編集モーダル -->
        <div id="edit-modal" class="modal hidden">
            <div class="modal-content">
                <button class="close-btn">&times;</button>
                <h2>勤怠データ編集</h2>
                <form id="edit-form">
                    <input type="hidden" id="edit-id">
                    
                    <div class="form-group">
                        <label for="edit-date">日付:</label>
                        <input type="date" id="edit-date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-site">現場名:</label>
                        <input type="text" id="edit-site" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="edit-clock-in">出勤時間:</label>
                            <input type="datetime-local" id="edit-clock-in" required>
                        </div>
                        <div class="form-col">
                            <label for="edit-clock-out">退勤時間:</label>
                            <input type="datetime-local" id="edit-clock-out">
                        </div>
                    </div>
                    
                    <div class="break-times">
                        <div class="break-title">
                            <span>休憩時間</span>
                            <button type="button" id="add-break-btn" class="btn btn-small btn-warning">追加</button>
                        </div>
                        <div id="break-list" class="break-list">
                            <!-- 休憩時間リスト -->
                        </div>
                        <div id="total-break-time" class="form-hint" style="text-align: right; margin-top: 10px;">
                            合計休憩時間: 0時間0分
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-notes">メモ:</label>
                        <textarea id="edit-notes" rows="3"></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">保存</button>
                        <button type="button" id="delete-record" class="btn btn-danger">削除</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 休憩時間追加モーダル -->
        <div id="break-modal" class="modal hidden">
            <div class="modal-content">
                <button class="close-btn" id="close-break-modal">&times;</button>
                <h2>休憩時間の追加</h2>
                <form id="break-form">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="break-start">開始時間:</label>
                            <input type="datetime-local" id="break-start" required>
                        </div>
                        <div class="form-col">
                            <label for="break-end">終了時間:</label>
                            <input type="datetime-local" id="break-end" required>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">追加</button>
                        <button type="button" id="cancel-break" class="btn btn-secondary">キャンセル</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- JavaScriptの参照 -->
    <script src="js/firebase.js" type="module" defer></script>
    <script src="js/auth.js" type="module" defer></script>
    <script src="js/utils.js" defer></script>
    <script src="js/login.js" type="module" defer></script>
    <script src="js/employee.js" type="module" defer></script>
    <script src="js/admin.js" type="module" defer></script>
    <script src="js/main.js" defer></script>

    <!-- Firebase SDK と認証処理 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, getDocs, addDoc, query, where, orderBy, limit, serverTimestamp, Timestamp, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        
        // Firebaseの設定
        const firebaseConfig = {
          apiKey: "AIzaSyCUCD0CLd6SQELpMK2f6KQFy2XVv5eMT2o",
          authDomain: "attendance-system-39ae6.firebaseapp.com",
          projectId: "attendance-system-39ae6",
          storageBucket: "attendance-system-39ae6.appspot.com",
          messagingSenderId: "723896381304",
          appId: "1:723896381304:web:92f31b721706dcbf11a28d",
          measurementId: "G-8DY7MWM44W"
        };
        
        // Firebaseの初期化
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // グローバル変数として公開（Firestoreの関数も含む）
        window.db = db;
        window.auth = auth;
        window.firebase = { app, db, auth };
        window.Firestore = {
            collection,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            getDocs,
            addDoc,
            query,
            where,
            orderBy,
            limit,
            serverTimestamp,
            Timestamp,
            deleteDoc
        };
        
        // すべてのユーザーネーム要素を更新
        function updateUserNames(userName) {
            document.querySelectorAll('.user-name').forEach(el => {
                el.textContent = userName;
            });
        }
        
        // 認証状態の変化を監視
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // ユーザーがログインしている場合
                console.log('ログイン中:', user.email);
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('user-section').style.display = 'block';
                
                // すべてのユーザー名表示を更新
                updateUserNames(user.displayName || user.email);
                
                // ユーザーのロールを取得して適切なページを表示
                try {
                    const userRef = doc(db, 'users', user.uid);
                    const userSnap = await getDoc(userRef);
                    
                    if (userSnap.exists()) {
                        const userData = userSnap.data();
                        const userRole = userData.role || 'employee';
                        
                        // ロールに基づいてページを表示
                        if (userRole === 'admin') {
                            hideAllPages();
                            document.getElementById('admin-page').classList.remove('hidden');
                            if (typeof window.initAdminPage === 'function') {
                                setTimeout(() => window.initAdminPage(), 200);
                            }
                        } else {
                            hideAllPages();
                            document.getElementById('employee-page').classList.remove('hidden');
                            if (typeof window.initEmployeePage === 'function') {
                                setTimeout(() => window.initEmployeePage(), 200);
                            }
                        }
                    } else {
                        // ユーザー情報がFirestoreにない場合はデフォルトで従業員として作成
                        await setDoc(userRef, {
                            email: user.email,
                            displayName: user.displayName || user.email,
                            role: 'employee',
                            createdAt: serverTimestamp()
                        });
                        
                        hideAllPages();
                        document.getElementById('employee-page').classList.remove('hidden');
                        if (typeof window.initEmployeePage === 'function') {
                            setTimeout(() => window.initEmployeePage(), 200);
                        }
                    }
                } catch (error) {
                    console.error('ユーザー情報の取得エラー:', error);
                    // エラーの場合でも従業員ページを表示
                    hideAllPages();
                    document.getElementById('employee-page').classList.remove('hidden');
                    if (typeof window.initEmployeePage === 'function') {
                        setTimeout(() => window.initEmployeePage(), 200);
                    }
                }
            } else {
                // ユーザーがログインしていない場合
                console.log('ログインしていません');
                document.getElementById('login-section').style.display = 'block';
                document.getElementById('user-section').style.display = 'none';
                hideAllPages();
                
                // ログインページにリダイレクト
                window.location.href = 'login.html';
            }
        });
        
        // すべてのログアウトボタンにイベントリスナーを追加
        function setupLogoutButtons() {
            document.querySelectorAll('#logout-button, .logout-button').forEach(button => {
                button.addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                        console.log('ログアウト成功');
                        window.location.href = 'login.html';
                    } catch (error) {
                        console.error('ログアウトエラー:', error);
                        alert('ログアウト中にエラーが発生しました');
                    }
                });
            });
        }
        
        // すべてのページを隠す関数
        function hideAllPages() {
            document.querySelectorAll('#employee-page, #admin-page').forEach(page => {
                page.classList.add('hidden');
            });
        }
        
        // DOMが読み込まれたらログアウトボタンを設定
        document.addEventListener('DOMContentLoaded', () => {
            setupLogoutButtons();
        });
        
        // グローバル関数として公開
        window.hideAllPages = hideAllPages;
        window.updateUserNames = updateUserNames;
    </script>
</body>
</html>
