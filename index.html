<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="css/style.css">
    
    <!-- Faviconè¿½åŠ  -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“‹</text></svg>">
    
    <!-- Firebase v8 SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- Firebaseè¨­å®š -->
    <script src="js/firebase.js"></script>
    
    <!-- ã‚·ã‚¹ãƒ†ãƒ ã®JavaScript -->
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/main.js"></script>
    <script src="js/employee.js"></script>
    <script src="js/admin.js"></script>
</head>
<body>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ -->
    <div id="login-page" class="page">
        <div class="container login-container">
            <div class="login-card">
                <h1>å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                <p class="login-subtitle">ãƒ­ã‚°ã‚¤ãƒ³</p>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label for="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" id="email" name="email" autocomplete="email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" id="password" name="password" autocomplete="current-password" required>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-full">ãƒ­ã‚°ã‚¤ãƒ³</button>
                    </div>
                    
                    <div id="error-message" class="error-text hidden"></div>
                </form>
                
                <div class="login-footer">
                    <p>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„æ–¹ã¯</p>
                    <a href="#" id="go-to-register" class="link">æ–°è¦ç™»éŒ²ã¯ã“ã¡ã‚‰</a>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°è¦ç™»éŒ²ãƒšãƒ¼ã‚¸ -->
    <div id="register-page" class="page hidden">
        <div class="login-container">
            <div class="login-card">
                <h1>å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                <h2>æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</h2>
                <form id="registerForm">
                    <div class="form-group">
                        <label for="reg-fullname">æ°å</label>
                        <input type="text" id="reg-fullname" name="fullname" required>
                    </div>
                    <div class="form-group">
                        <label for="reg-email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" id="reg-email" name="email" autocomplete="email" required>
                    </div>
                    <div class="form-group">
                        <label for="reg-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" id="reg-password" name="password" autocomplete="new-password" required>
                        <div class="form-hint">6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„</div>
                    </div>
                    <div class="form-group">
                        <label for="reg-role">å½¹å‰²</label>
                        <select id="reg-role" name="role">
                            <option value="employee">å¾“æ¥­å“¡</option>
                            <option value="admin">ç®¡ç†è€…</option>
                        </select>
                    </div>
                    <div id="register-message" class="error-text"></div>
                    <button type="submit" class="btn btn-primary btn-full">ç™»éŒ²ã™ã‚‹</button>
                </form>
                <p style="text-align: center; margin-top: 20px;">
                    ã™ã§ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®æ–¹ã¯<br>
                    <a href="#" id="back-to-login">ãƒ­ã‚°ã‚¤ãƒ³ã¯ã“ã¡ã‚‰</a>
                </p>
            </div>
        </div>
    </div>

    <!-- å¾“æ¥­å“¡ç”»é¢ -->
    <div id="employee-page" class="page hidden">
        <div class="container">
            <header class="app-header">
                <h1>å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                <div class="user-info">
                    <span id="user-name"></span>
                    <button class="btn btn-secondary btn-small" id="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </header>

            <main class="employee-main">
                <!-- ç¾åœ¨æ™‚åˆ»è¡¨ç¤º -->
                <div class="date-display">
                    <div class="date" id="current-date">æ—¥ä»˜èª­ã¿è¾¼ã¿ä¸­...</div>
                    <div class="time" id="current-time">æ™‚åˆ»èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>

                <!-- å‹¤å‹™çŠ¶æ³ -->
                <div id="clock-status" class="clock-status">
                    <div class="status-waiting">å‡ºå‹¤ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
                </div>

                <!-- å‡ºé€€å‹¤ãƒ»ä¼‘æ†©ãƒœã‚¿ãƒ³ -->
                <div class="clock-buttons">
                    <div class="button-row">
                        <button class="btn btn-primary clock-btn" id="clock-in-btn">å‡ºå‹¤</button>
                        <button class="btn btn-secondary clock-btn" id="clock-out-btn" disabled>é€€å‹¤</button>
                    </div>
                    <div class="button-row">
                        <button class="btn btn-warning clock-btn" id="break-start-btn" disabled>ä¼‘æ†©é–‹å§‹</button>
                        <button class="btn btn-warning clock-btn" id="break-end-btn" disabled>ä¼‘æ†©çµ‚äº†</button>
                    </div>
                </div>

                <!-- ç¾å ´é¸æŠ -->
                <div class="site-selection">
                    <div class="form-group">
                        <label for="site-name">ç¾å ´åï¼š</label>
                        <select id="site-name" required>
                            <option value="">ç¾å ´ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="æ–°å®¿ã‚ªãƒ•ã‚£ã‚¹ãƒ“ãƒ«æ”¹ä¿®å·¥äº‹">æ–°å®¿ã‚ªãƒ•ã‚£ã‚¹ãƒ“ãƒ«æ”¹ä¿®å·¥äº‹</option>
                            <option value="æ¸‹è°·ãƒãƒ³ã‚·ãƒ§ãƒ³å»ºè¨­ç¾å ´">æ¸‹è°·ãƒãƒ³ã‚·ãƒ§ãƒ³å»ºè¨­ç¾å ´</option>
                            <option value="æ¨ªæµœå€‰åº«è£œä¿®å·¥äº‹">æ¨ªæµœå€‰åº«è£œä¿®å·¥äº‹</option>
                            <option value="other">ãã®ä»–ï¼ˆç›´æ¥å…¥åŠ›ï¼‰</option>
                        </select>
                        <input type="text" id="other-site" placeholder="ãã®ä»–ã®ç¾å ´åã‚’å…¥åŠ›" style="display: none; margin-top: 10px;">
                    </div>
                </div>

                <!-- ä½œæ¥­ãƒ¡ãƒ¢ -->
                <div class="form-group">
                    <label for="work-notes">ä½œæ¥­ãƒ¡ãƒ¢ï¼š</label>
                    <textarea id="work-notes" placeholder="ä½œæ¥­å†…å®¹ã‚’è¨˜å…¥ï¼ˆä»»æ„ï¼‰" rows="3"></textarea>
                </div>

                <!-- æœ€è¿‘ã®è¨˜éŒ² -->
                <section class="recent-records">
                    <h3>æœ€è¿‘ã®è¨˜éŒ²</h3>
                    <div id="recent-list">
                        <!-- å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- ç®¡ç†è€…ç”»é¢ -->
    <div id="admin-page" class="page hidden">
        <div class="container">
            <header class="app-header">
                <h1>å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                <div class="user-info">
                    <span id="admin-user-name"></span>
                    <button id="admin-logout-btn" class="btn btn-secondary btn-small">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </header>

            <main class="admin-main">
                <div class="admin-tabs">
                    <button class="tab-btn active" data-tab="daily">æ—¥åˆ¥è¡¨ç¤º</button>
                    <button class="tab-btn" data-tab="monthly">æœˆåˆ¥è¡¨ç¤º</button>
                    <button class="tab-btn" data-tab="employee">å¾“æ¥­å“¡åˆ¥</button>
                    <button class="tab-btn" data-tab="site">ç¾å ´åˆ¥</button>
                </div>

                <div class="filter-row">
                    <div class="date-filter">
                        <label class="filter-label">æ—¥ä»˜:</label>
                        <input type="date" id="filter-date">
                    </div>
                    <div class="month-filter hidden">
                        <label class="filter-label">æœˆ:</label>
                        <input type="month" id="filter-month">
                    </div>
                    <div class="employee-filter hidden">
                        <label class="filter-label">å¾“æ¥­å“¡:</label>
                        <select id="filter-employee">
                            <option value="">å…¨å“¡</option>
                        </select>
                    </div>
                    <div class="site-filter hidden">
                        <label class="filter-label">ç¾å ´:</label>
                        <select id="filter-site">
                            <option value="">å…¨ã¦ã®ç¾å ´</option>
                        </select>
                    </div>
                    <div class="filter-actions">
                        <button id="export-csv" class="btn btn-primary">CSVå‡ºåŠ›</button>
                    </div>
                </div>

                <div class="attendance-table-container">
                    <table class="attendance-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="userName">å¾“æ¥­å“¡å</th>
                                <th class="sortable" data-sort="date">æ—¥ä»˜</th>
                                <th class="sortable" data-sort="siteName">ç¾å ´å</th>
                                <th>å‹¤å‹™æ™‚é–“</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-data">
                            <!-- å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ -->
                        </tbody>
                    </table>
                </div>
            </main>
        </div>

        <!-- å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="edit-modal" class="modal hidden">
            <div class="modal-content">
                <button class="close-btn">&times;</button>
                <h2>å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ç·¨é›†</h2>
                <form id="edit-form">
                    <input type="hidden" id="edit-id">
                    
                    <div class="form-group">
                        <label for="edit-date">æ—¥ä»˜:</label>
                        <input type="date" id="edit-date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-site">ç¾å ´å:</label>
                        <input type="text" id="edit-site" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="edit-clock-in">å‡ºå‹¤æ™‚é–“:</label>
                            <input type="datetime-local" id="edit-clock-in" required>
                        </div>
                        <div class="form-col">
                            <label for="edit-clock-out">é€€å‹¤æ™‚é–“:</label>
                            <input type="datetime-local" id="edit-clock-out">
                        </div>
                    </div>
                    
                    <div class="break-times">
                        <div class="break-title">
                            <span>ä¼‘æ†©æ™‚é–“</span>
                            <button type="button" id="add-break-btn" class="btn btn-small btn-warning">è¿½åŠ </button>
                        </div>
                        <div id="break-list" class="break-list">
                            <!-- ä¼‘æ†©æ™‚é–“ãƒªã‚¹ãƒˆ -->
                        </div>
                        <div id="total-break-time" class="form-hint" style="text-align: right; margin-top: 10px;">
                            åˆè¨ˆä¼‘æ†©æ™‚é–“: 0æ™‚é–“0åˆ†
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-notes">ãƒ¡ãƒ¢:</label>
                        <textarea id="edit-notes" rows="3"></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                        <button type="button" id="delete-record" class="btn btn-danger">å‰Šé™¤</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ä¼‘æ†©æ™‚é–“è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="break-modal" class="modal hidden">
            <div class="modal-content">
                <button class="close-btn" id="close-break-modal">&times;</button>
                <h2>ä¼‘æ†©æ™‚é–“ã®è¿½åŠ </h2>
                <form id="break-form">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="break-start">é–‹å§‹æ™‚é–“:</label>
                            <input type="datetime-local" id="break-start" required>
                        </div>
                        <div class="form-col">
                            <label for="break-end">çµ‚äº†æ™‚é–“:</label>
                            <input type="datetime-local" id="break-end" required>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">è¿½åŠ </button>
                        <button type="button" id="cancel-break" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ãƒšãƒ¼ã‚¸å›ºæœ‰ã®JavaScript -->
    <script src="js/login.js"></script>
    
    <script>
        // ãƒšãƒ¼ã‚¸ã®åˆæœŸè¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º
            showPage('login');
        });
    </script>

    <!-- å®Œå…¨ãªå¾“æ¥­å“¡ãƒšãƒ¼ã‚¸ä¿®æ­£ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”§ å®Œå…¨ãªå¾“æ¥­å“¡ãƒšãƒ¼ã‚¸ä¿®æ­£ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’é–‹å§‹...');
            
            // å…¨ã¦ã® Firestore ã‚¯ã‚¨ãƒªã‚’å˜ç´”åŒ–
            overrideFirestoreQueries();
            
            // å¾“æ¥­å“¡ãƒšãƒ¼ã‚¸åˆæœŸåŒ–ã®å®Œå…¨ãªä¸Šæ›¸ã
            overrideEmployeeInitialization();
            
            // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å¼·åŒ–
            setupGlobalErrorHandling();
        });

        // Firestoreã‚¯ã‚¨ãƒªã®å®Œå…¨ãªä¸Šæ›¸ã
        function overrideFirestoreQueries() {
            console.log('ğŸ“ Firestoreã‚¯ã‚¨ãƒªã‚’ä¸Šæ›¸ãä¸­...');
            
            // æœ€è¿‘ã®è¨˜éŒ²èª­ã¿è¾¼ã¿ã‚’å®Œå…¨ã«å®‰å…¨ã«ã™ã‚‹
            window.loadRecentRecords = async function() {
                console.log('ğŸ” å®‰å…¨ãªæœ€è¿‘ã®è¨˜éŒ²èª­ã¿è¾¼ã¿ã‚’å®Ÿè¡Œ...');
                
                try {
                    const user = firebase.auth().currentUser;
                    if (!user) {
                        console.log('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                        showNoRecordsMessage();
                        return;
                    }
                    
                    // æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¯ã‚¨ãƒªã®ã¿å®Ÿè¡Œ
                    const simpleQuery = firebase.firestore()
                        .collection('attendance')
                        .where('userId', '==', user.uid)
                        .limit(3);
                    
                    console.log('ğŸ”„ ã‚·ãƒ³ãƒ—ãƒ«ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œä¸­...');
                    const snapshot = await simpleQuery.get();
                    
                    if (snapshot.empty) {
                        console.log('ğŸ“‹ è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        showNoRecordsMessage();
                        return;
                    }
                    
                    console.log('âœ… è¨˜éŒ²å–å¾—æˆåŠŸ:', snapshot.size, 'ä»¶');
                    displayRecords(snapshot);
                    
                } catch (error) {
                    console.error('âŒ ã‚¯ã‚¨ãƒªã‚¨ãƒ©ãƒ¼:', error);
                    handleQueryError(error);
                }
            };
            
            // å‡ºå‹¤å‡¦ç†ã®ç°¡ç•¥åŒ–
            window.handleClockIn = async function() {
                console.log('ğŸ¢ å‡ºå‹¤å‡¦ç†ã‚’å®Ÿè¡Œ...');
                
                try {
                    const user = firebase.auth().currentUser;
                    if (!user) {
                        alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                        return;
                    }
                    
                    const siteName = document.getElementById('site-name').value;
                    if (!siteName) {
                        alert('ç¾å ´ã‚’é¸æŠã—ã¦ãã ã•ã„');
                        return;
                    }
                    
                    const now = new Date();
                    const dateString = now.toISOString().split('T')[0];
                    
                    // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ
                    const docData = {
                        userId: user.uid,
                        date: dateString,
                        siteName: siteName,
                        startTime: now.toLocaleTimeString('ja-JP'),
                        status: 'working',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    console.log('ğŸ’¾ å‡ºå‹¤ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ä¸­...', docData);
                    
                    await firebase.firestore()
                        .collection('attendance')
                        .add(docData);
                    
                    console.log('âœ… å‡ºå‹¤è¨˜éŒ²å®Œäº†');
                    alert('å‡ºå‹¤ã—ã¾ã—ãŸ');
                    
                    // UIæ›´æ–°
                    updateClockStatus('working');
                    loadRecentRecords();
                    
                } catch (error) {
                    console.error('âŒ å‡ºå‹¤ã‚¨ãƒ©ãƒ¼:', error);
                    alert('å‡ºå‹¤è¨˜éŒ²ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            };
        }

        // å¾“æ¥­å“¡ãƒšãƒ¼ã‚¸åˆæœŸåŒ–ã®å®Œå…¨ä¸Šæ›¸ã
        function overrideEmployeeInitialization() {
            console.log('ğŸ¯ å¾“æ¥­å“¡ãƒšãƒ¼ã‚¸åˆæœŸåŒ–ã‚’ä¸Šæ›¸ãä¸­...');
            
            // æ—¢å­˜ã®åˆæœŸåŒ–é–¢æ•°ã‚’ç½®ãæ›ãˆ
            window.initEmployeePage = function() {
                console.log('ğŸš€ å¾“æ¥­å“¡ãƒšãƒ¼ã‚¸åˆæœŸåŒ–é–‹å§‹ï¼ˆä¿®æ­£ç‰ˆï¼‰');
                
                try {
                    // åŸºæœ¬çš„ãªæ™‚åˆ»è¡¨ç¤º
                    updateCurrentTime();
                    setInterval(updateCurrentTime, 1000);
                    
                    // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
                    setupButtonEvents();
                    
                    // ç¾å ´é¸æŠã®è¨­å®š
                    setupSiteSelection();
                    
                    // æœ€è¿‘ã®è¨˜éŒ²ã‚’å®‰å…¨ã«èª­ã¿è¾¼ã¿
                    setTimeout(loadRecentRecords, 2000);
                    
                    console.log('âœ… å¾“æ¥­å“¡ãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†ï¼ˆä¿®æ­£ç‰ˆï¼‰');
                    
                } catch (error) {
                    console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚åŸºæœ¬æ©Ÿèƒ½ã¯å‹•ä½œã•ã›ã‚‹
                    setupBasicFunctions();
                }
            };
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        function setupGlobalErrorHandling() {
            console.log('ğŸ›¡ï¸ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¨­å®šä¸­...');
            
            // Firestoreã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ
            window.addEventListener('unhandledrejection', function(event) {
                if (event.reason && event.reason.code) {
                    console.log('ğŸ” Firestoreã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ:', event.reason.code);
                    
                    if (event.reason.code === 'failed-precondition' || 
                        event.reason.code === 'permission-denied') {
                        console.log('ğŸ› ï¸ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–ã—ã¦ç¶šè¡Œ');
                        event.preventDefault();
                        
                        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                        showIndexErrorMessage();
                    }
                }
            });
        }

        // åŸºæœ¬æ©Ÿèƒ½ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupBasicFunctions() {
            console.log('âš™ï¸ åŸºæœ¬æ©Ÿèƒ½ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­...');
            
            // ç¾åœ¨æ™‚åˆ»è¡¨ç¤º
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            setupButtonEvents();
            
            // ç¾å ´é¸æŠ
            setupSiteSelection();
            
            console.log('âœ… åŸºæœ¬æ©Ÿèƒ½ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†');
        }

        // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®š
        function setupButtonEvents() {
            console.log('ğŸ”˜ ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®šä¸­...');
            
            const clockInBtn = document.getElementById('clock-in-btn');
            const clockOutBtn = document.getElementById('clock-out-btn');
            const breakStartBtn = document.getElementById('break-start-btn');
            const breakEndBtn = document.getElementById('break-end-btn');
            
            if (clockInBtn) clockInBtn.onclick = handleClockIn;
            if (clockOutBtn) clockOutBtn.onclick = handleClockOut;
            if (breakStartBtn) breakStartBtn.onclick = handleBreakStart;
            if (breakEndBtn) breakEndBtn.onclick = handleBreakEnd;
            
            console.log('âœ… ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šå®Œäº†');
        }

        // ç¾å ´é¸æŠã®è¨­å®š
        function setupSiteSelection() {
            const siteSelect = document.getElementById('site-name');
            const otherSiteInput = document.getElementById('other-site');
            
            if (siteSelect) {
                siteSelect.onchange = function() {
                    if (this.value === 'other') {
                        otherSiteInput.style.display = 'block';
                        otherSiteInput.required = true;
                    } else {
                        otherSiteInput.style.display = 'none';
                        otherSiteInput.required = false;
                    }
                };
            }
        }

        // ç¾åœ¨æ™‚åˆ»ã®æ›´æ–°
        function updateCurrentTime() {
            const now = new Date();
            const dateElement = document.getElementById('current-date');
            const timeElement = document.getElementById('current-time');
            
            if (dateElement) {
                dateElement.textContent = now.toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
            }
            
            if (timeElement) {
                timeElement.textContent = now.toLocaleTimeString('ja-JP');
            }
        }

        // è¨˜éŒ²ãªã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
        function showNoRecordsMessage() {
            const recentList = document.getElementById('recent-list');
            if (recentList) {
                recentList.innerHTML = `
                    <div class="no-records-safe">
                        <h4>ğŸ¯ å‹¤æ€ ã‚·ã‚¹ãƒ†ãƒ ã¸ã‚ˆã†ã“ã</h4>
                        <p>ã¾ã å‹¤æ€ è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        <p>å‡ºå‹¤ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦å‹¤å‹™ã‚’é–‹å§‹ã—ã¾ã—ã‚‡ã†</p>
                        <div class="tips">
                            <strong>ä½¿ã„æ–¹:</strong>
                            <ol>
                                <li>ç¾å ´ã‚’é¸æŠ</li>
                                <li>å‡ºå‹¤ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                                <li>ä¼‘æ†©æ™‚ã¯ä¼‘æ†©ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨</li>
                                <li>é€€å‹¤æ™‚ã¯é€€å‹¤ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                            </ol>
                        </div>
                    </div>
                `;
            }
        }

        // è¨˜éŒ²ã®è¡¨ç¤º
        function displayRecords(snapshot) {
            const recentList = document.getElementById('recent-list');
            if (!recentList) return;
            
            let html = '<h4>ğŸ“‹ æœ€è¿‘ã®è¨˜éŒ²</h4>';
            
            snapshot.forEach(doc => {
                const data = doc.data();
                html += `
                    <div class="record-item-safe">
                        <div class="record-header">
                            <span class="record-date">${data.date || 'æ—¥ä»˜ä¸æ˜'}</span>
                            <span class="record-status">${data.status || 'çŠ¶æ…‹ä¸æ˜'}</span>
                        </div>
                        <div class="record-details">
                            <div class="record-site">ğŸ“ ${data.siteName || 'ç¾å ´ä¸æ˜'}</div>
                            <div class="record-time">
                                â° é–‹å§‹: ${data.startTime || 'ä¸æ˜'}
                                ${data.endTime ? ` çµ‚äº†: ${data.endTime}` : ' (å‹¤å‹™ä¸­)'}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            recentList.innerHTML = html;
        }

        // ã‚¯ã‚¨ãƒªã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
        function handleQueryError(error) {
            console.log('ğŸ”§ ã‚¯ã‚¨ãƒªã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†ä¸­:', error.code);
            
            const recentList = document.getElementById('recent-list');
            if (recentList) {
                recentList.innerHTML = `
                    <div class="error-safe">
                        <h4>âš ï¸ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã®æ³¨æ„</h4>
                        <p>è¨˜éŒ²ã®èª­ã¿è¾¼ã¿ã§å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>
                        <p><strong>å‡ºå‹¤ãƒ»é€€å‹¤æ©Ÿèƒ½ã¯æ­£å¸¸ã«å‹•ä½œã—ã¾ã™</strong></p>
                        <button onclick="loadRecentRecords()" class="retry-btn">ğŸ”„ å†è©¦è¡Œ</button>
                        <div class="error-info">
                            <details>
                                <summary>ã‚¨ãƒ©ãƒ¼è©³ç´°</summary>
                                <code>${error.message}</code>
                            </details>
                        </div>
                    </div>
                `;
            }
        }

        // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        function showIndexErrorMessage() {
            const message = document.createElement('div');
            message.className = 'index-error-notice';
            message.innerHTML = `
                <div class="notice-content">
                    <h4>ğŸ” ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±</h4>
                    <p>Firestoreã®è¨­å®šã‚’æœ€é©åŒ–ä¸­ã§ã™</p>
                    <p><strong>å‹¤æ€ æ©Ÿèƒ½ã¯æ­£å¸¸ã«å‹•ä½œã—ã¾ã™</strong></p>
                </div>
            `;
            message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                border-radius: 8px;
                padding: 15px;
                max-width: 300px;
                z-index: 9999;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            `;
            
            document.body.appendChild(message);
            
            setTimeout(() => {
                if (message.parentNode) {
                    message.parentNode.removeChild(message);
                }
            }, 8000);
        }

        // å‹¤å‹™çŠ¶æ³ã®æ›´æ–°
        function updateClockStatus(status) {
            const statusElement = document.getElementById('clock-status');
            if (statusElement) {
                let message = '';
                switch(status) {
                    case 'working':
                        message = '<div class="status-working">âœ… å‹¤å‹™ä¸­ã§ã™</div>';
                        break;
                    case 'break':
                        message = '<div class="status-break">â¸ï¸ ä¼‘æ†©ä¸­ã§ã™</div>';
                        break;
                    default:
                        message = '<div class="status-waiting">â° å‡ºå‹¤ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>';
                }
                statusElement.innerHTML = message;
            }
        }

        // CSSè¿½åŠ 
        const additionalCSS = `
            .no-records-safe, .error-safe {
                text-align: center;
                padding: 20px;
                border: 2px dashed #3498db;
                border-radius: 12px;
                background: #f8f9fa;
                margin: 15px 0;
            }
            
            .no-records-safe h4, .error-safe h4 {
                color: #2c3e50;
                margin-bottom: 10px;
            }
            
            .tips {
                text-align: left;
                background: #e8f4fd;
                padding: 15px;
                border-radius: 8px;
                margin-top: 15px;
            }
            
            .tips ol {
                margin: 10px 0;
                padding-left: 20px;
            }
            
            .record-item-safe {
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 12px;
                margin-bottom: 10px;
                background: #fff;
            }
            
            .record-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            }
            
            .record-date {
                font-weight: bold;
                color: #2c3e50;
            }
            
            .record-status {
                background: #3498db;
                color: white;
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 0.8em;
            }
            
            .record-details {
                font-size: 0.9em;
                color: #7f8c8d;
            }
            
            .retry-btn {
                background: #3498db;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                margin-top: 10px;
            }
            
            .retry-btn:hover {
                background: #2980b9;
            }
            
            .error-info {
                margin-top: 10px;
                text-align: left;
            }
            
            .error-info code {
                background: #f1f2f6;
                padding: 5px;
                border-radius: 3px;
                font-size: 0.8em;
            }
            
            .status-working {
                color: #27ae60;
                font-weight: bold;
                padding: 10px;
                background: #d5f4e6;
                border-radius: 8px;
            }
            
            .status-break {
                color: #f39c12;
                font-weight: bold;
                padding: 10px;
                background: #fef9e7;
                border-radius: 8px;
            }
            
            .status-waiting {
                color: #7f8c8d;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 8px;
            }
        `;

        // CSSè¿½åŠ 
        const styleSheet = document.createElement('style');
        styleSheet.textContent = additionalCSS;
        document.head.appendChild(styleSheet);

        console.log('ğŸ‰ å®Œå…¨ãªå¾“æ¥­å“¡ãƒšãƒ¼ã‚¸ä¿®æ­£ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿å®Œäº†');
    </script>

</body>
</html>
