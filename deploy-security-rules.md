# Firebaseセキュリティルール デプロイ手順

## 🚨 重要: セキュリティルールの適用

新しいセキュリティルールを作成しました。以下の手順で適用してください：

### 1. Firebase CLI のインストール（必要な場合）
```bash
npm install -g firebase-tools
```

### 2. Firebase プロジェクトにログイン
```bash
firebase login
```

### 3. プロジェクトの初期化（初回のみ）
```bash
firebase init firestore
# 既存の firestore.rules を使用することを選択
```

### 4. セキュリティルールのデプロイ
```bash
firebase deploy --only firestore:rules
```

### 5. インデックスのデプロイ（必要な場合）
```bash
firebase deploy --only firestore:indexes
```

## ⚠️ デプロイ前の注意事項

1. **本番環境での作業**: 現在の設定は`attendance-system-39ae6`プロジェクトに適用されます
2. **既存ユーザーへの影響**: 新しいルールにより一時的にアクセスエラーが発生する可能性があります
3. **段階的適用**: テスト環境での検証を推奨します

## 🔧 新しいセキュリティルールの主な機能

### テナント分離の強化
- テナント間のデータアクセスを完全に分離
- ユーザーは自分のテナントデータのみアクセス可能
- super_adminのみ全テナントアクセス可能

### ロールベースアクセス制御
- `employee`: 自分の勤怠データのみ
- `admin`: テナント内の全データ管理
- `super_admin`: 全テナント管理

### セキュリティ強化
- URLパラメータ操作によるテナント侵入を防止
- 不正なロール変更を防止
- 監査ログによる操作追跡

## 🧪 テスト項目

デプロイ後に以下をテストしてください：

1. **認証テスト**
   - ログイン/ログアウト
   - ユーザー情報の取得

2. **テナント分離テスト**
   - 異なるテナントデータへの不正アクセス試行
   - URLパラメータ操作による侵入試行

3. **ロール権限テスト**
   - 従業員による管理機能アクセス試行
   - 管理者による他テナントアクセス試行

4. **データ操作テスト**
   - 勤怠データの作成/更新/削除
   - ユーザー管理機能
   - 設定変更機能

## 🔧 トラブルシューティング

### Permission Denied エラーが発生する場合
1. Firebase Console でルールが正しく適用されているか確認
2. ユーザーの `global_users` ドキュメントが正しく設定されているか確認
3. テナントIDが正しく設定されているか確認

### 既存データとの互換性問題
1. `global_users` コレクションにユーザーデータが存在するか確認
2. 必要に応じてデータ移行スクリプトを実行
3. レガシー `users` コレクションとの整合性確認